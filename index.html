<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PING-PONG DB PRO</title>
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/512/ping-pong.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/512/ping-pong.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="íƒêµ¬ DB">

    <style>
        /* [ìƒ‰ìƒ ë° ê¸°ë³¸ ì„¤ì •] */
        :root { 
            --primary: #2e7d32; 
            --secondary: #1976d2; 
            --danger: #d32f2f; 
            --bg: #f8f9fa; 
            --card-bg: #ffffff; 
            /* 1. ë²„íŠ¼ ë°°ê²½ (ì—°ë‘ -> ì§„ì´ˆë¡ ê·¸ë¼ë°ì´ì…˜) */
            --home-btn-bg: linear-gradient(135deg, #66bb6a, #2e7d32);
            /* 2. ë²„íŠ¼ ê·¸ë¦¼ì (ì´ˆë¡ìƒ‰ íˆ¬ëª… ê·¸ë¦¼ì) */
            --home-btn-shadow: rgba(46, 125, 50, 0.4);
        }
        
        /* [ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤] ì‹œê°„ 4ì´ˆë¡œ ë³€ê²½ */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            z-index: 20000; 
            animation: fadeOut 0.5s forwards; animation-delay: 4.5s; /* 1ì´ˆ ì—°ì¥ë¨ */
        }
        
        #intro-layer video {
            width: 85%; max-width: 350px;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            outline: none;
        }
        
        .intro-text {
            margin-top: 20px; font-size: 14px; color: #666; font-weight: bold;
            opacity: 0; animation: fadeIn 0.5s forwards; animation-delay: 0.2s;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }

        body { 
            font-family: 'Pretendard', sans-serif; background-color: var(--bg); 
            margin: 0; padding: 10px; color: #333; line-height: 1.4; font-size: 14px;
        }
        
        /* ì»¨í…Œì´ë„ˆ */
        .container { 
            max-width: 500px; margin: auto; background: white; padding: 20px; 
            border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); min-height: 85vh;
            display: flex; flex-direction: column; 
        }

        /* [ë©”ì¸ ë©”ë‰´ ìŠ¤íƒ€ì¼] */
        #mainMenuLayer {
            flex: 1; 
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
        }

        .main-title-area {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        /* [ìˆ˜ì •ë¨] íƒ€ì´í‹€ í…ìŠ¤íŠ¸ ê·¸ë¼ë°ì´ì…˜ ì ìš©, ì´ëª¨ì§€ëŠ” ì œì™¸ */
        .main-title-text {
            font-size: 4.0em; 
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -2px;
            background: linear-gradient(135deg, #1b5e20 0%, #66bb6a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.2));
            display: inline-block;
        }
        
        /* [ìˆ˜ì •ë¨] ì´ëª¨ì§€ëŠ” ì›ë˜ ìƒ‰ìƒ ìœ ì§€ */
        .main-title-icon {
            font-size: 4.0em;
            vertical-align: top;
            filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.2));
        }

        .version-tag-inline { 
            font-size: 14px; 
            background: #eee; 
            color: #555; 
            padding: 3px 8px; 
            border-radius: 8px; 
            font-weight: bold; 
            vertical-align: middle;
            margin-left: 5px;
        }

        .main-footer-info {
            text-align: center;
            color: #bbb;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .header-container { 
            margin-bottom: 20px; border-bottom: 2px solid #eee; 
            padding-bottom: 15px; display: flex; flex-direction: column; 
        }
        .header-title { 
            color: var(--primary); margin: 0; font-size: 1.5em; font-weight: 800; 
            text-align: center; width: 100%; display: flex; align-items: center; 
            justify-content: center; gap: 5px; 
        }

        /* [ìˆ˜ì •ë¨] ë©”ì¸ ë²„íŠ¼: í•œ ì¤„ í‘œì‹œ, í°íŠ¸ í™•ëŒ€ */
        .main-menu-btn {
            display: flex; align-items: center; justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
            width: 100%; padding: 35px 15px; margin-bottom: 20px;
            border-radius: 20px; border: none; 
            font-size: 22px; /* ëª¨ë°”ì¼ì—ì„œ í•œì¤„ë¡œ ë‚˜ì˜¬ ìˆ˜ ìˆëŠ” ìµœëŒ€ í¬ê¸° ê³ ë ¤ */
            font-weight: 900;
            cursor: pointer; transition: 0.2s; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            word-break: keep-all;
        }
        .main-menu-btn span {
            display: inline-block;
        }
        .main-menu-btn:active { transform: scale(0.97); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-game { background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; }
        .btn-rank { background: linear-gradient(135deg, #42a5f5, #1976d2); color: white; }
        
        .box { 
            background: var(--card-bg); padding: 15px; border-radius: 18px; margin-bottom: 12px; 
            border: 1px solid rgba(0,0,0,0.07); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        .flex-row { display: flex; gap: 6px; margin-bottom: 10px; align-items: flex-start; }
        .input-group { flex: 1; display: flex; flex-direction: column; }
        .filter-label { font-size: 10px; font-weight: bold; color: #888; margin-bottom: 3px; padding-left: 2px; }
        
        select, input, button { font-size: 14px !important; }
        select, input { padding: 8px; border-radius: 10px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; height: 40px; }
        button { border: none; border-radius: 12px; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        
        .btn-blue { background-color: var(--secondary); color: white; }
        .btn-orange { background-color: #ff9800; color: white; margin-top: 8px; }
        .btn-red { background-color: var(--danger); color: white; margin-top: 15px; padding: 6px; opacity: 0.7; font-size: 11px !important; }
        
        /* [ìˆ˜ì •ë¨] í™ˆ ë²„íŠ¼: ì‚°ëœ»í•œ ì˜¤ë Œì§€ìƒ‰ */
        .btn-home { 
            background: var(--home-btn-bg); 
            color: white; 
            margin: 0 auto 15px auto; 
            display: block;
            width: 80%; 
            padding: 14px 20px; font-size: 16px !important; font-weight: bold;
            box-shadow: 0 6px 15px var(--home-btn-shadow); 
            border-radius: 30px; /* ë” ë‘¥ê¸€ê²Œ */
        }
        
        #saveBtn {
            box-shadow: 0 8px 20px rgba(46, 125, 50, 0.3);
            margin-top: 10px;
            padding: 15px;
            font-size: 16px !important;
        }

        .switch-container { display: flex; align-items: center; justify-content: space-between; background: #eee; padding: 4px; border-radius: 12px; margin-bottom: 8px; }
        .switch-btn { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .switch-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .player-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .player-item { background: #f9f9f9; padding: 8px 12px; border-radius: 10px; border: 1px solid #eee; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .player-item input { width: 16px; height: 16px; margin: 0; }
        
        .scoreboard { display: flex; justify-content: space-around; align-items: center; background: #2c3e50; color: white; padding: 15px; border-radius: 18px; margin: 12px 0; }
        .score-num { font-size: 2.5em; font-weight: 900; }
        
        .match-card { background: #fff; border-radius: 14px; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.07); box-shadow: 0 6px 15px rgba(0,0,0,0.5); }
        .match-btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .match-btn-group button { padding: 8px; background: #f4f4f4; color: #555; }
        .selected-a { background: var(--secondary) !important; color: white !important; }
        .selected-b { background: var(--danger) !important; color: white !important; }
        
        .type-badge { padding: 2px 6px; border-radius: 6px; font-weight: bold; font-size: 12px; color: white; margin-left: 6px; }
        .type-singles { background-color: #9c27b0; }
        .type-doubles { background-color: #009688; }
        .win-prob { font-size: 13px; color: #aaa; font-weight: normal; margin: 0 4px; }
        .win-prob.high { color: #ff5722; font-weight: 800; }
        
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 10000; justify-content: center; align-items: center; font-weight: bold; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 11000; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 420px; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .modal-close-x { font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; }
        
        .confetti { position: fixed; width: 8px; height: 8px; z-index: 12000; top: -10px; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: var(--primary); color: white; padding: 10px 4px; font-size: 13px; }
        td { padding: 12px 4px; text-align: center; border-bottom: 1px solid #eee; }
        .rank-num { font-weight: 800; font-size: 15px; color: #666; }
        .rank-name { font-size: 15px; font-weight: 800; }
        .rank-winrate { font-size: 16px; font-weight: 800; }
        
        .period-btns { display: flex; gap: 4px; margin-bottom: 8px; width: 100%; }
        .btn-p { flex: 1; padding: 8px 2px; background: #eee; color: #666; border-radius: 8px; font-size: 14px !important; }
        .btn-p.active { background: var(--primary); color: white; }
        
        .clickable-name { color: var(--secondary); text-decoration: underline; cursor: pointer; }
        .vs-detail { font-size: 11px; color: #666; display: block; margin-top: 2px; }
        .vs-detail b { font-size: 14px; color: #333; }
        .vs-detail-rate { font-size: 12px; color: var(--primary); font-weight: 800; margin-left: 2px; }
        
        #teamPreviewArea { text-align: center; font-size: 15px; font-weight: 800; color: #444; margin-bottom: 15px; background: #f0f0f0; padding: 10px 12px; border-radius: 12px; line-height: 1.3; }
        .team-label-a { color: var(--secondary); font-size: 13px; }
        .team-label-b { color: var(--danger); font-size: 13px; }
        .vs-divider { display: block; font-size: 11px; color: #bbb; margin: 2px 0; font-weight: normal; }

        .money-input { width: 60px; text-align: right; padding: 4px; border-radius: 6px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div id="intro-layer">
    <video autoplay muted playsinline>
        <source src="intro.mp4" type="video/mp4">
        ì˜ìƒì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </video>
    <div class="intro-text">í´ë¼ìš°ë“œ ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
</div>

<div id="loading">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>

<div class="container">
    
    <div id="mainMenuLayer">
        <div class="main-title-area">
            <div>
                <span class="main-title-icon">ğŸ“</span>
                <div class="main-title-text" style="font-size: 45px !important;">
                    PING-PONG<br>DB PRO
                </div>
                <span class="version-tag-inline">V1.30</span>
            </div>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
            <button class="main-menu-btn btn-game" onclick="showScreen('game')" style="font-size: 30px;">
                <span style="font-size: 21px !important; display: block;">ğŸš€ ëŒ€ì§„í‘œ ìƒì„± / ê²½ê¸° ê¸°ë¡</span>
            </button>
            <button class="main-menu-btn btn-rank" onclick="showScreen('rank')" style="font-size: 30px;">
                <span style="font-size: 21px !important; display: block;">ğŸ“Š ë­í‚¹ í™•ì¸ </span>
            </button>
        </div>

        <div class="main-footer-info">
            <div>Since '26.2/9</div>
            <div style="font-weight: bold; margin-top: 4px;">Designed by KS</div>
        </div>
    </div>

    <div id="gameLayer" style="display:none;">
        <div class="header-container">
            <div class="header-title">ğŸ“ ëŒ€ì§„í‘œ ìƒì„± ë° ê²½ê¸° ê¸°ë¡</div>
        </div>
        <button class="btn-home" onclick="showScreen('main')">ğŸ  ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
        
        <div class="box">
            <h3 style="margin:0 0 10px 0; font-size:16px; color:var(--primary);">âš™ï¸ ê²½ê¸° ì„¤ì •</h3>
            <div class="flex-row">
                <div class="input-group" style="flex: 1.5;">
                    <label class="filter-label">ë‚ ì§œ</label>
                    <input type="date" id="matchDate" onchange="checkDateData()">
                </div>
                <div class="input-group">
                    <label class="filter-label">ì‹œê°„</label>
                    <select id="matchTime" onchange="checkDateData()">
                        <option value="lunch">ì ì‹¬</option>
                        <option value="dinner">ì €ë…</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="filter-label">íšŒì°¨</label>
                    <select id="matchSession" onchange="checkDateData(); render();">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                        <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
            </div>
            <div id="dateStatus" style="text-align:center; font-size: 11px; margin-bottom:10px; font-weight: bold;"></div>
            
            <div style="margin-top: 5px;">
                <button class="btn-blue" onclick="openModal('playerModal')">ğŸ‘¥ ì°¸ì—¬ì ì„ íƒ (<span id="selectedCountText">0</span>ëª…)</button>
                <div class="flex-row" style="margin-top:8px;">
                    <div class="input-group">
                        <label class="filter-label">ë°©ì‹</label>
                        <select id="gameMode">
                            <option value="mixed">í˜¼í•©(ë³µ/ë‹¨)</option>
                            <option value="doubles">ì „ë¶€ ë³µì‹</option>
                            <option value="singles">ì „ë¶€ ë‹¨ì‹</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="filter-label">ìŠ¹ë¦¬ ê¸°ì¤€</label>
                        <select id="winCondition">
                            <option value="1">ë‹¨íŒ!</option>
                            <option value="3">3íŒ 2ì„ ìŠ¹</option>
                            <option value="5">5íŒ 3ì„ ìŠ¹</option>
                            <option value="7">7íŒ 4ì„ ìŠ¹</option>
                            <option value="9">9íŒ 5ì„ ìŠ¹</option>
                            <option value="11">11íŒ 6ì„ ìŠ¹</option>
                        </select>
                    </div>
                </div>
                <div class="switch-container">
                    <div id="balance_tight" class="switch-btn active" onclick="setBalanceMode('tight')">âš–ï¸ ë°•ë¹™(ì‹¤ë ¥ìˆœ)</div>
                    <div id="balance_random" class="switch-btn" onclick="setBalanceMode('random')">ğŸ² ìš´ë¹¨(ëœë¤)</div>
                </div>
                <button class="btn-orange" onclick="handleSmartStart()">ğŸš€ ìƒˆ ëŒ€ì§„í‘œ ìƒì„±</button>
            </div>
        </div>

        <div id="matchArea" style="display:none;">
            <div class="scoreboard">
                <div style="text-align:center;">
                    <div id="scoreA" class="score-num" style="color:#64b5f6;">0</div>
                    <div style="font-size:11px;">TEAM A</div>
                </div>
                <div style="font-size:1.5em; opacity:0.3;">VS</div>
                <div style="text-align:center;">
                    <div id="scoreB" class="score-num" style="color:#f28b82;">0</div>
                    <div style="font-size:11px;">TEAM B</div>
                </div>
            </div>
            <div id="teamPreviewArea"></div>
            <div id="lineupArea"></div>
            <button id="saveBtn" class="btn-blue" style="background:var(--primary); margin-top:5px;" onclick="handleManualSave()">ğŸ ê²½ê¸° ê²°ê³¼ ìµœì¢… ì €ì¥</button>
        </div>
    </div>

    <div id="rankLayer" style="display:none;">
        <div class="header-container">
            <div class="header-title">ğŸ“Š íŒŒì›Œ ë­í‚¹ ë° ê²Œì„ë¹„ ë­í‚¹</div>
        </div>
        <button class="btn-home" onclick="showScreen('main')">ğŸ  ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</button>
        
        <div class="box">
            <h3 style="text-align:center; margin-top:0; font-size:15px; color:#444;">ì¡°íšŒ ê¸°ê°„ ì„¤ì •</h3>
            <div class="period-btns">
                <button class="btn-p active" onclick="setQuickPeriod(0, this)">ì „ì²´</button>
                <button class="btn-p" onclick="setQuickPeriod(1, this)">1ê°œì›”</button>
                <button class="btn-p" onclick="setQuickPeriod(2, this)">2ê°œì›”</button>
                <button class="btn-p" onclick="setQuickPeriod(3, this)">3ê°œì›”</button>
            </div>
            <div class="flex-row">
                <div class="input-group">
                    <label class="filter-label">ì‹œì‘ì¼</label>
                    <input type="date" id="statsStart" onchange="updateUI()">
                </div>
                <div class="input-group">
                    <label class="filter-label">ì¢…ë£Œì¼</label>
                    <input type="date" id="statsEnd" onchange="updateUI()">
                </div>
            </div>
            
            <h4 style="font-size:13px; border-left:3px solid var(--primary); padding-left:8px; margin:15px 0 5px 0;">ğŸ† íŒŒì›Œ ë­í‚¹</h4>
            <div id="rankingTableArea"></div>
            
            <h4 style="font-size:13px; border-left:3px solid var(--danger); padding-left:8px; margin:25px 0 5px 0;">ğŸ’¸ ê²Œì„ë¹„ ê¸°ë¶€ ë­í‚¹</h4>
            <div id="moneyRankingTableArea"></div>

            <button class="btn-red" onclick="resetDatabase()">âš ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>

</div>

<div id="playerModal" class="modal-overlay" onclick="closeModalOnOuterClick(event, 'playerModal')">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-weight: 800; font-size: 16px;">ì°¸ì—¬ì ì„ íƒ</span>
            <span class="modal-close-x" onclick="closeModal('playerModal')">Ã—</span>
        </div>
        <div id="playerGrid" class="player-grid"></div>
        <button class="btn-blue" style="margin-top:15px;" onclick="closeModal('playerModal')">ì„ íƒ ì™„ë£Œ</button>
    </div>
</div>

<div id="recordModal" class="modal-overlay" onclick="closeClickOut(event, 'recordModal')">
    <div class="modal-content">
        <div class="modal-header">
            <span id="recordModalTitle" style="font-weight: 800; font-size: 16px;">ìƒëŒ€ ì „ì </span>
            <span class="modal-close-x" onclick="closeModal('recordModal')">Ã—</span>
        </div>
        <div id="recordTableArea"></div>
    </div>
</div>

<div id="moneyInputModal" class="modal-overlay" onclick="closeClickOut(event, 'moneyInputModal')">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-weight: 800; font-size: 16px;">ğŸ’¸ ê²Œì„ë¹„ ì…ë ¥ (ì²œì› ë‹¨ìœ„)</span>
            <span class="modal-close-x" onclick="closeModal('moneyInputModal')">Ã—</span>
        </div>
        <div id="moneyInputList" style="margin-top:10px;"></div>
        <button class="btn-blue" style="margin-top:15px;" onclick="saveMoneyAndFinish()">ê¸ˆì•¡ ì €ì¥ ë° ì¢…ë£Œ</button>
    </div>
</div>

<script>
     /* [ë°ì´í„° ì €ì¥ì†Œ] êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì™€ í†µì‹ í•˜ëŠ” ì£¼ì†Œì˜ˆìš” */
    const API_URL = "https://script.google.com/macros/s/AKfycbzTImCgYtXbc4yN3VSNahYj6MKi9c36GZkF7rt8ofkE8asQWd95deMk05D8rHJMc06v/exec"; 

    /*  í…ŒìŠ¤íŠ¸ DB ì£¼ì†Œ : https://script.google.com/macros/s/AKfycbztrs5aqu_1RW_w-H0LzsszCivwGhh-fkHFtouGKlYYohwhPWtCbeORWcw1mzsTFoKJ/exec  */
    /*  ë°°í¬ DB ì£¼ì†Œ : https://script.google.com/macros/s/AKfycbzTImCgYtXbc4yN3VSNahYj6MKi9c36GZkF7rt8ofkE8asQWd95deMk05D8rHJMc06v/exec  */

    function checkAccess() {
        const now = new Date();
        const day = now.getDay(); 
        const hour = now.getHours();
        const min = now.getMinutes();
        const currentTime = hour * 100 + min;

        const isWeekday = (day >= 1 && day <= 5);
        const isLunchTime = (currentTime >= 1130 && currentTime <= 1300);
        const isDinnerTime = (currentTime >= 1700 && currentTime <= 1900);

        if (isWeekday && (isLunchTime || isDinnerTime)) {
            return true;
        } else {
            const msg = !isWeekday ? "ì£¼ë§ì€ ê²Œì„ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤." : "ê²Œì„ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (í‰ì¼ 11:30~13:00 / 17:00~19:00)";
            const password = prompt(msg + "\nê³„ì† ì§„í–‰í•˜ì‹œë ¤ë©´ ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return (password === "7640"); 
        }
    }

    const fixedList = ["ê¹€ê¸°í˜‘", "ê¹€í•™ê¸°", "ê¹€í˜„ì§„", "ì´ê²½ìƒ", "ì´ëª…ì² ", "ì´ì£¼í•­", "ì´ì¤€í˜¸", "ì´ì§„í–‰", "ê¹€ìš©ë²”", "ì´ì„í˜„", "ì¡°ì»¤1", "ì¡°ì»¤2"];
    let db = { matchHistory: {}, moneyHistory: [] }; 
    let currentMatchData = null;
    let currentBalanceMode = 'tight';
    let isAlreadySaved = false;

    window.onload = function() {
        const today = new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0];
        document.getElementById('matchDate').value = today;
        document.getElementById('statsEnd').value = today;
        initPlayerList(); 
        syncWithCloud();
    };

    /* [í™”ë©´ ì „í™˜ í•¨ìˆ˜] */
    function showScreen(screenName) {
        document.getElementById('mainMenuLayer').style.display = 'none';
        document.getElementById('gameLayer').style.display = 'none';
        document.getElementById('rankLayer').style.display = 'none';

        if(screenName === 'main') {
            document.getElementById('mainMenuLayer').style.display = 'flex'; // ë©”ì¸ì€ Flex ì‚¬ìš©
        } else if(screenName === 'game') {
            document.getElementById('gameLayer').style.display = 'block';
            checkDateData(); 
        } else if(screenName === 'rank') {
            document.getElementById('rankLayer').style.display = 'block';
            updateUI(); 
        }
    }

    function setBalanceMode(mode) {
        currentBalanceMode = mode;
        document.getElementById('balance_tight').classList.toggle('active', mode === 'tight');
        document.getElementById('balance_random').classList.toggle('active', mode === 'random');
    }

    function initPlayerList() {
        const grid = document.getElementById('playerGrid'); 
        grid.innerHTML = "";
        fixedList.forEach(name => {
            const div = document.createElement('div'); 
            div.className = "player-item";
            div.innerHTML = `<input type="checkbox" name="player" value="${name}"> <span>${name}</span>`;
            div.onclick = function(e) { 
                const cb = this.querySelector('input'); 
                if(e.target !== cb) cb.checked = !cb.checked; 
                updateCount(); 
            };
            grid.appendChild(div);
        });
    }

    function updateCount() { document.getElementById('selectedCountText').innerText = document.querySelectorAll('input[name="player"]:checked').length; }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function closeModalOnOuterClick(e, id) { if(e.target.id === id) closeModal(id); }
    function closeClickOut(e, id) { if(e.target.id === id) closeModal(id); }
    function getCurrentKey() { return `${document.getElementById('matchDate').value}_${document.getElementById('matchTime').value}_s${document.getElementById('matchSession').value}`; }

    async function syncWithCloud() {
        try { 
            const response = await fetch(`${API_URL}?t=${Date.now()}`);
            const text = await response.text(); 
            if(text && text !== "EMPTY") { 
                db = JSON.parse(text); 
                if(!db.matchHistory) db.matchHistory = {}; 
                if(!db.moneyHistory) db.moneyHistory = []; 
            }
            updateUI(); 
            checkDateData();
        } catch(e) { console.error(e); }
    }

    function checkDateData() {
        const key = getCurrentKey();
        const matchData = db.matchHistory[key];
        if(matchData) {
            document.getElementById('dateStatus').innerHTML = "âœ… ê¸°ì¡´ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.";
            document.getElementById('dateStatus').style.color = "var(--secondary)";
            currentMatchData = JSON.parse(JSON.stringify(matchData));
            document.getElementById('matchArea').style.display = 'block';
            isAlreadySaved = true; render(); 
        } else {
            document.getElementById('dateStatus').innerHTML = "âšª ê¸°ë¡ ì—†ìŒ (ìƒˆ ëŒ€ì§„ ìƒì„± ê°€ëŠ¥)";
            document.getElementById('dateStatus').style.color = "#ccc";
            document.getElementById('matchArea').style.display = 'none';
            isAlreadySaved = false;
        }
    }

    function updateUI() {
        if(!db.matchHistory) return;
        let stats = {}; 
        let moneyStats = {}; 
        fixedList.forEach(n => {
            stats[n] = { win: 0, total: 0 };
            moneyStats[n] = { money: 0, loses: 0 };
        });

        const start = document.getElementById('statsStart').value;
        const end = document.getElementById('statsEnd').value;

        Object.keys(db.matchHistory).forEach(key => {
            const dStr = key.substring(0, 10);
            if((start && dStr < start) || (end && dStr > end)) return;
            const m = db.matchHistory[key]; if(!m || !m.results) return;
            m.lineups.forEach(l => {
                const res = m.results[l.id]; if(!res) return;
                const win = res === 'A' ? l.pA : l.pB, lose = res === 'A' ? l.pB : l.pA;
                win.forEach(p => { if(stats[p]) { stats[p].win++; stats[p].total++; } });
                lose.forEach(p => { 
                    if(stats[p]) stats[p].total++; 
                    if(moneyStats[p]) moneyStats[p].loses++;
                });
            });
        });

        if(db.moneyHistory) {
            db.moneyHistory.forEach(entry => {
                if((start && entry.date < start) || (end && entry.date > end)) return;
                if(moneyStats[entry.name]) moneyStats[entry.name].money += entry.amount;
            });
        }

        let sorted = Object.entries(stats).filter(x=>x[1].total>0).sort((a,b) => (b[1].win/b[1].total) - (a[1].win/a[1].total));
        let html = `<table><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ê²Œì„</th><th>ìŠ¹</th><th>ìŠ¹ë¥ </th></tr>`;
        sorted.forEach(([n, d], i) => { 
            html += `<tr><td class="rank-num">${i+1}</td><td><b class="clickable-name rank-name" onclick="showVersusStats('${n}')">${n}</b></td><td>${d.total}</td><td>${d.win}</td><td><b class="rank-winrate" style="color:var(--primary)">${((d.win/d.total)*100).toFixed(1)}%</b></td></tr>`; 
        });
        document.getElementById('rankingTableArea').innerHTML = sorted.length ? html + "</table>" : "<p style='text-align:center; font-size:12px; color:#aaa;'>ê¸°ë¡ ì—†ìŒ</p>";

        let mSorted = Object.entries(moneyStats).filter(x => x[1].money > 0 || x[1].loses > 0).sort((a,b) => b[1].money - a[1].money);
        let mHtml = `<table><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>íŒ¨ë°°ìˆ˜</th><th>ê¸°ë¶€ì•¡</th></tr>`;
        mSorted.forEach(([n, d], i) => {
            mHtml += `<tr><td class="rank-num">${i+1}</td><td class="rank-name">${n}</td><td>${d.loses}íšŒ</td><td><b style="color:#d32f2f;">${d.money.toLocaleString()},000ì›</b></td></tr>`;
        });
        document.getElementById('moneyRankingTableArea').innerHTML = mSorted.length ? mHtml + "</table>" : "<p style='text-align:center; font-size:12px; color:#aaa;'>ê¸°ë¶€ ë‚´ì—­ ì—†ìŒ</p>";
    }

    function showVersusStats(name) {
        if(!db.matchHistory) return;
        document.getElementById('recordModalTitle').innerText = `ğŸ”¥ ${name} vs ìƒëŒ€ ì „ì `;
        let vsStats = {}; 
        const start = document.getElementById('statsStart').value;
        const end = document.getElementById('statsEnd').value;
        Object.keys(db.matchHistory).forEach(key => {
            const dStr = key.substring(0, 10);
            if((start && dStr < start) || (end && dStr > end)) return;
            const m = db.matchHistory[key]; if(!m || !m.results) return;
            m.lineups.forEach(l => {
                const res = m.results[l.id]; if(!res) return;
                const teamA = l.pA, teamB = l.pB;
                const isA = teamA.includes(name), isB = teamB.includes(name);
                if(isA || isB) {
                    const oppTeam = isA ? teamB : teamA;
                    const won = (isA && res === 'A') || (isB && res === 'B');
                    oppTeam.forEach(opp => {
                        if(!vsStats[opp]) vsStats[opp] = { singles: { win: 0, total: 0 }, doubles: { win: 0, total: 0 } };
                        if(l.type === 'ë‹¨ì‹') { vsStats[opp].singles.total++; if(won) vsStats[opp].singles.win++; }
                        else { vsStats[opp].doubles.total++; if(won) vsStats[opp].doubles.win++; }
                    });
                }
            });
        });
        let sorted = Object.entries(vsStats).sort((a,b) => (b[1].singles.total + b[1].doubles.total) - (a[1].singles.total + a[1].doubles.total));
        let html = `<table><tr><th>ìƒëŒ€</th><th>ì´ ê²Œì„</th><th>ìƒì„¸ ì „ì  (ìŠ¹/ì „)</th></tr>`;
        sorted.forEach(([n, d]) => {
            const s = d.singles, dbData = d.doubles;
            html += `<tr><td><b class="rank-name">${n}</b></td><td>${s.total + dbData.total}</td><td style="text-align:left; padding-left:10px;">
                <span class="vs-detail">ğŸ“ğŸ‘¤ ë‹¨ì‹: <b>${s.win}</b>/${s.total}<span class="vs-detail-rate">(${s.total?Math.round(s.win/s.total*100):0}%)</span></span>
                <span class="vs-detail">ğŸ“ğŸ“ ë³µì‹: <b>${dbData.win}</b>/${dbData.total}<span class="vs-detail-rate">(${dbData.total?Math.round(dbData.win/dbData.total*100):0}%)</span></span>
            </td></tr>`;
        });
        document.getElementById('recordTableArea').innerHTML = sorted.length ? html + "</table>" : "<p style='text-align:center; padding:20px;'>ê¸°ë¡ ì—†ìŒ</p>";
        openModal('recordModal');
    }

    function setQuickPeriod(m, btn) {
        document.querySelectorAll('.btn-p').forEach(b => b.classList.remove('active')); 
        btn.classList.add('active');
        const start = new Date(); 
        if(m === 0) document.getElementById('statsStart').value = "";
        else { start.setMonth(start.getMonth() - m); document.getElementById('statsStart').value = start.toISOString().split('T')[0]; }
        updateUI();
    }

    function handleSmartStart() {
        if (!checkAccess()) return; 
        const d = document.getElementById('matchDate').value;
        const t = document.getElementById('matchTime').value;
        const s = document.getElementById('matchSession').value;
        const key = `${d}_${t}_s${s}`;
        
        if (db.matchHistory && db.matchHistory[key]) {
            let nextS = -1;
            for (let i = 1; i <= 10; i++) {
                if (!db.matchHistory[`${d}_${t}_s${i}`]) { nextS = i; break; }
            }
            
            if (nextS !== -1) {
                if (confirm(`í˜„ì¬ ${s}íšŒì°¨ëŠ” ì´ë¯¸ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.\në‹¤ìŒ ë¹ˆ íšŒì°¨(${nextS}íšŒì°¨)ë¡œ ì´ë™í•˜ì—¬ ëŒ€ì§„í‘œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    document.getElementById('matchSession').value = nextS;
                    isAlreadySaved = false;
                    checkDateData(); 
                    startMatching();
                    return;
                }
            }

            if (confirm(`í˜„ì¬ íšŒì°¨(${s}íšŒì°¨)ì˜ ê¸°ë¡ì„ ë®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                if (confirm(`âš ï¸ ì •ë§ë¡œ ë®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ë°ì´í„°ëŠ” ì™„ì „íˆ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    isAlreadySaved = true;
                    startMatching();
                }
            }
        } else { 
            isAlreadySaved = false; 
            startMatching(); 
        }
    }

    function startMatching() {
        const selected = Array.from(document.querySelectorAll('input[name="player"]:checked')).map(c => c.value);
        if (selected.length < 2) { alert("2ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”!"); return; }

        let stats = {}; 
        fixedList.forEach(n => stats[n] = { win: 0, total: 0 });
        Object.values(db.matchHistory).forEach(m => {
            if(!m.results) return;
            m.lineups.forEach(l => {
                const res = m.results[l.id]; if(!res) return;
                const win = res === 'A' ? l.pA : l.pB, lose = res === 'A' ? l.pB : l.pA;
                win.forEach(p => { if(stats[p]) { stats[p].win++; stats[p].total++; } });
                lose.forEach(p => { if(stats[p]) stats[p].total++; });
            });
        });
        const winRates = {};
        fixedList.forEach(n => winRates[n] = (stats[n].total === 0) ? 0.5 : (stats[n].win / stats[n].total));

        let aPool = [], bPool = [];
        if (currentBalanceMode === 'tight') {
            const sorted = [...selected].sort((p1, p2) => winRates[p2] - winRates[p1]);
            sorted.forEach((p, i) => (Math.floor(i / 2) % 2 === 0 ? (i % 2 === 0 ? aPool : bPool) : (i % 2 === 0 ? bPool : aPool)).push(p));
        } else {
            const shuffled = [...selected].sort(() => Math.random() - 0.5);
            shuffled.forEach((p, i) => (i < shuffled.length / 2 ? aPool : bPool).push(p));
        }

        const wc = parseInt(document.getElementById('winCondition').value) || 1;
        const mode = document.getElementById('gameMode').value;
        
        let oppPairHistory = [];     
        let partnerPairHistory = []; 
        let singlesPlayCount = {};   
        selected.forEach(p => singlesPlayCount[p] = 0);
        let consecutiveCount = {};   
        selected.forEach(p => consecutiveCount[p] = 0);
        
        currentMatchData = { teams: { a: aPool, b: bPool }, lineups: [], results: {}, config: { winCon: wc } };

        for (let i = 1; i <= wc; i++) {
            let isDoubles = (mode === 'doubles' || (mode === 'mixed' && i % 2 !== 0));
            if (aPool.length < 2 || bPool.length < 2) isDoubles = false;

            let bestMatch = null;
            let minPenalty = Infinity;

            if (isDoubles) {
                for (let a1 of aPool) for (let a2 of aPool) {
                    if (a1 === a2) continue;
                    for (let b1 of bPool) for (let b2 of bPool) {
                        if (b1 === b2) continue;
                        const pA = [a1, a2].sort(); const pB = [b1, b2].sort();
                        let penalty = calculatePenalty(pA, pB, 'ë³µì‹', oppPairHistory, partnerPairHistory, singlesPlayCount, consecutiveCount, winRates);
                        if (penalty < minPenalty) { minPenalty = penalty; bestMatch = { pA, pB, type: 'ë³µì‹' }; }
                    }
                }
            } else {
                for (let pa of aPool) for (let pb of bPool) {
                    const pA = [pa], pB = [pb];
                    let penalty = calculatePenalty(pA, pB, 'ë‹¨ì‹', oppPairHistory, partnerPairHistory, singlesPlayCount, consecutiveCount, winRates);
                    if (penalty < minPenalty) { minPenalty = penalty; bestMatch = { pA, pB, type: 'ë‹¨ì‹' }; }
                }
            }

            const playersThisMatch = [...bestMatch.pA, ...bestMatch.pB];
            if (bestMatch.type === 'ë³µì‹') {
                partnerPairHistory.push(bestMatch.pA.join('|'), bestMatch.pB.join('|'));
            } else {
                bestMatch.pA.concat(bestMatch.pB).forEach(p => singlesPlayCount[p]++);
            }
            bestMatch.pA.forEach(a => bestMatch.pB.forEach(b => oppPairHistory.push([a, b].sort().join('|'))));
            
            selected.forEach(p => {
                if (playersThisMatch.includes(p)) consecutiveCount[p]++;
                else consecutiveCount[p] = 0;
            });

            const avgA = bestMatch.pA.reduce((s, p) => s + winRates[p], 0) / bestMatch.pA.length;
            const avgB = bestMatch.pB.reduce((s, p) => s + winRates[p], 0) / bestMatch.pB.length;
            const probA = Math.round(avgA / (avgA + avgB) * 100) || 50;

            currentMatchData.lineups.push({ id: i, pA: bestMatch.pA, pB: bestMatch.pB, type: bestMatch.type, probA: probA });
        }

        document.getElementById('matchArea').style.display = 'block';
        render();
    }

    function calculatePenalty(pA, pB, type, oppHist, partHist, singHist, consHist, winRates) {
        let penalty = 0;
        const currentAll = [...pA, ...pB];
        const avgA = pA.reduce((s, p) => s + winRates[p], 0) / pA.length;
        const avgB = pB.reduce((s, p) => s + winRates[p], 0) / pB.length;
        penalty += Math.abs(avgA - avgB) * 100;

        pA.forEach(a => pB.forEach(b => {
            const pair = [a, b].sort().join('|');
            penalty += oppHist.filter(h => h === pair).length * 1000;
        }));

        if (type === 'ë³µì‹') {
            penalty += partHist.filter(h => h === pA.join('|') || h === pB.join('|')).length * 2000;
        }

        if (type === 'ë‹¨ì‹') {
            currentAll.forEach(p => penalty += singHist[p] * 5000);
        }

        currentAll.forEach(p => {
            if (consHist[p] >= 2) penalty += 10000;
            else if (consHist[p] === 1) penalty += 50; 
        });

        return penalty + Math.random(); 
    }

    function render() {
        if(!currentMatchData || !currentMatchData.lineups) return;
        const area = document.getElementById('lineupArea'); 
        area.innerHTML = "";
        let wA=0, wB=0; 
        if(!currentMatchData.results) currentMatchData.results = {};
        Object.values(currentMatchData.results).forEach(v => (v==='A'?wA++:(v==='B'?wB++:0)));
        document.getElementById('scoreA').innerText = wA; 
        document.getElementById('scoreB').innerText = wB;
        
        // [íŒ€ ì •ë³´ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€] 
        if (currentMatchData.teams) {
            const aTeam = currentMatchData.teams.a ? currentMatchData.teams.a.join(', ') : '';
            const bTeam = currentMatchData.teams.b ? currentMatchData.teams.b.join(', ') : '';
            document.getElementById('teamPreviewArea').innerHTML = `
                <span class="team-label-a">TEAM A</span><br>${aTeam}<br>
                <span class="vs-divider">â€” VS â€”</span>
                <span class="team-label-b">TEAM B</span><br>${bTeam}`;
        }

        currentMatchData.lineups.forEach(m => {
            const win = currentMatchData.results[m.id], typeClass = m.type === 'ë‹¨ì‹' ? 'type-singles' : 'type-doubles';
            const probA = m.probA || 50;
            const probB = 100 - probA;

            // [ì¶”ê°€ëœ ì•„ì´ì½˜ ë¡œì§]
            const typeIcon = m.type === 'ë‹¨ì‹' ? 'ğŸ“' : 'ğŸ“ğŸ“';

            const card = document.createElement('div'); 
            card.className = 'match-card';
            if(win) card.style.borderLeft = `8px solid ${win==='A'?'var(--secondary)':'var(--danger)'}`;
            card.innerHTML = `<div style="display:flex; align-items:center;"><small style="color:#888;">#${m.id}</small><span class="type-badge ${typeClass}">${typeIcon} ${m.type}</span></div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0; font-weight:bold;">
                    <div style="flex:1.2; text-align:left; font-size: 15px;">${m.pA.join(', ')}</div> 
                    <div style="flex:1.5; text-align:center;">
                        <span class="win-prob ${probA > probB ? 'high' : ''}">${probA}%</span> VS <span class="win-prob ${probB > probA ? 'high' : ''}">${probB}%</span>
                    </div>
                    <div style="flex:1.2; text-align:right; font-size: 15px;">${m.pB.join(', ')}</div>
                </div>
                <div class="match-btn-group"><button class="${win==='A'?'selected-a':''}" onclick="record(${m.id},'A')">A ìŠ¹</button><button class="${win==='B'?'selected-b':''}" onclick="record(${m.id},'B')">B ìŠ¹</button></div>`;
            area.appendChild(card);
        });

        const date = document.getElementById('matchDate').value;
        const session = document.getElementById('matchSession').value;
        const time = document.getElementById('matchTime').value;

        const currentSessionMoney = db.moneyHistory.filter(m => 
            m.date === date && 
            String(m.session) === String(session) && 
            m.time === time
        );

        if (currentSessionMoney.length > 0) {
            const moneyDiv = document.createElement('div');
            moneyDiv.style.cssText = "margin-top:20px; padding:15px; background:#fff9f0; border-radius:18px; border:1px solid #ffe0b2; box-shadow: 0 4px 12px rgba(0,0,0,0.05);";

            let html = `<div style="font-size:13px; color:#e65100; font-weight:800; margin-bottom:10px;">
                            <span>ğŸ’°</span> ${session}íšŒì°¨ ê¸°ë¶€ ë‚´ì—­
                        </div>`;

            currentSessionMoney.forEach(m => {
                html += `<div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:6px; padding-bottom:4px; border-bottom:1px dashed #ffe0b2;">
                            <span style="color:#555;">${m.name}</span>
                            <span style="font-weight:bold; color:#333;">${m.amount.toLocaleString()},000ì›</span>
                         </div>`;
            });

            moneyDiv.innerHTML = html;
            area.appendChild(moneyDiv);
        }
    }

    function record(id, w) {
        if (isAlreadySaved) {
            if (!confirm("ê¸°ì¡´ì— ì €ì¥ëœ ê²½ê¸° ê²°ê³¼ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            if (!confirm("ë³€ê²½ ì‹œ ë‚˜ì¤‘ì— 'ìµœì¢… ì €ì¥'ì„ ëˆŒëŸ¬ì•¼ í´ë¼ìš°ë“œì— ë°˜ì˜ë©ë‹ˆë‹¤. ì •ë§ ì§„í–‰í• ê¹Œìš”?")) return;
        }

        currentMatchData.results[id] = (currentMatchData.results[id] === w) ? null : w;
        render();
        let a = 0, b = 0, target = Math.ceil(currentMatchData.config.winCon / 2);
        Object.values(currentMatchData.results).forEach(v => (v === 'A' ? a++ : (v === 'B' ? b++ : 0)));
        if (a >= target || b >= target) { 
            triggerConfetti();
            const winner = (a >= target) ? 'AíŒ€' : 'BíŒ€';
            const loserList = (a >= target) ? currentMatchData.teams.b : currentMatchData.teams.a;
            setTimeout(() => { 
                alert(`ğŸ‰ ${winner} ìµœì¢… ìŠ¹ë¦¬!`); 
                if (confirm(`ê²½ê¸° ê²°ê³¼ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) saveToCloud(loserList); 
            }, 500); 
        }
    }

    function triggerConfetti() {
        for (let i = 0; i < 50; i++) {
            const c = document.createElement('div'); c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw'; c.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 50%)`;
            c.style.animationDuration = (Math.random()*3+2)+'s'; document.body.appendChild(c);
            setTimeout(() => c.remove(), 5000);
        }
    }

    async function saveToCloud(losers = []) {
        if (isAlreadySaved || db.matchHistory[getCurrentKey()]) {
            if (!confirm("í•´ë‹¹ íšŒì°¨ì— ì´ë¯¸ ì €ì¥ëœ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            if (!confirm("âš ï¸ ê¸°ì¡´ ë°ì´í„°ê°€ ì™„ì „íˆ ì‚­ì œë˜ê³  í˜„ì¬ ê²°ê³¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤. ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        }

        document.getElementById('loading').style.display = 'flex';
        db.matchHistory[getCurrentKey()] = currentMatchData;
        try { 
            await fetch(API_URL, {method:"POST", body:JSON.stringify({type:"SAVE", db:db}), mode:'no-cors'}); 
            alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
            isAlreadySaved = true; 
            await syncWithCloud();
            handlePostSavePopups(losers);
        } catch(e) { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); } 
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function handlePostSavePopups(losers) {
        if (!losers || losers.length === 0) return;
        if (losers.length > 1) {
            if (confirm("íŒ¨ë°°íŒ€ì€ ë˜˜ë˜˜ë§ì´ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                applyToltol(losers);
            } else {
                confirmMoneyInput(losers);
            }
        } else {
            confirmMoneyInput(losers);
        }
    }

    function confirmMoneyInput(losers) {
        setTimeout(() => {
            if (confirm("ê²Œì„ë¹„ ê¸°ë¶€ ë‚´ì—­ì„ ì…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                showMoneyInputModal(losers);
            }
        }, 300);
    }

    function applyToltol(losers) {
        document.querySelectorAll('input[name="player"]').forEach(cb => cb.checked = false);
        losers.forEach(name => {
            const cb = document.querySelector(`input[name="player"][value="${name}"]`);
            if(cb) cb.checked = true;
        });
        updateCount();
        let curS = parseInt(document.getElementById('matchSession').value);
        if(curS < 10) {
            document.getElementById('matchSession').value = curS + 1;
            checkDateData(); 
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
        alert("íŒ¨ë°° ì¸ì›ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëŒ€ì§„ì„ ìƒì„±í•˜ì„¸ìš”.");
    }

    function showMoneyInputModal(losers) {
        const listArea = document.getElementById('moneyInputList');
        listArea.innerHTML = "";
        losers.forEach(name => {
            listArea.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding: 10px; background: #f9f9f9; border-radius: 12px;">
                    <span style="font-weight:bold;">${name}</span>
                    <div style="display:flex; align-items:center;">
                        <input type="number" class="money-input" data-name="${name}" placeholder="0"> ì²œì›
                    </div>
                </div>`;
        });
        openModal('moneyInputModal');
    }

    async function saveMoneyAndFinish() {
        closeModal('moneyInputModal');
        if(!confirm("ì…ë ¥í•œ ê¸°ë¶€ ê¸ˆì•¡ì„ ì •ë§ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return; 
        }

        const inputs = document.querySelectorAll('.money-input');
        const date = document.getElementById('matchDate').value;
        const session = document.getElementById('matchSession').value; 
        const time = document.getElementById('matchTime').value; 

        let hasData = false;

        inputs.forEach(input => {
            const amount = parseInt(input.value);
            if(amount > 0) {
                db.moneyHistory.push({
                    date: date,
                    session: session, 
                    time: time,
                    name: input.dataset.name,
                    amount: amount
                });
                hasData = true;
            }
        });

        if(hasData) {
            document.getElementById('loading').style.display = 'flex';
            try {
                await fetch(API_URL, {method: "POST", body: JSON.stringify({type: "SAVE", db: db}), mode: 'no-cors'});
                alert("ê¸°ë¶€ì•¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch(e) {
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                document.getElementById('loading').style.display = 'none';
                showScreen('main'); 
            }
        }
        updateUI();
    }

    async function resetDatabase() {
        const pw = prompt("ë¹„ë°€ë²ˆí˜¸?");
        if (pw === "7640" && confirm("ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            document.getElementById('loading').style.display = 'flex';
            db = { matchHistory: {}, moneyHistory: [] };
            try { 
                await fetch(API_URL, {method: "POST", body: JSON.stringify({type: "SAVE", db: db}), mode: 'no-cors'}); 
                alert("ì´ˆê¸°í™”ë¨"); 
                updateUI(); 
            }
            catch (e) { alert("ì˜¤ë¥˜"); } 
            finally { document.getElementById('loading').style.display = 'none'; }
        }
    }

    function handleManualSave() { 
        if (!checkAccess()) return; 
        if(confirm("ìµœì¢… ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            let a=0, b=0;
            Object.values(currentMatchData.results).forEach(v=>(v==='A'?a++:(v==='B'?b++:0)));
            const loserList = (a >= b) ? currentMatchData.teams.b : currentMatchData.teams.a;
            saveToCloud(loserList); 
        } 
    }

    if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./service-worker.js"); }
</script>
</body>
</html>


